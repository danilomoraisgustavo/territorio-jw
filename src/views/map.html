<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Territories</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
    <h1>Territories</h1>
    <div id="map" style="height: 400px;"></div>
    <table id="territoriesTable" border="1">
        <thead>
            <tr>
                <th>ID</th>
                <th>Number</th>
                <th>Zone</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
    <div id="lotsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);">
        <div style="position: relative; width: 80%; height: 80%; margin: 5% auto; background: #fff;">
            <button id="closeModal" style="position: absolute; top: 10px; right: 10px; z-index: 1000;">X</button>
            <h2 id="modalTitle" style="text-align: center; margin-top: 10px;">Lotes do Território</h2>
            <div id="lotsMap" style="width: 100%; height: 90%;"></div>
        </div>
    </div>
    <script>
        var mainMap = L.map('map').setView([-23.532, -46.792], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(mainMap);

        var mainLayers = {};

        fetch('/territories')
            .then(response => response.json())
            .then(data => {
                var tbody = document.querySelector('#territoriesTable tbody');
                data.forEach(territory => {
                    var color = 'red';
                    if (territory.status) {
                        if (territory.updated_at) {
                            var updatedDate = new Date(territory.updated_at);
                            var sixMonthsAgo = new Date();
                            sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
                            if (updatedDate > sixMonthsAgo) {
                                color = 'green';
                            }
                        } else {
                            color = 'red';
                        }
                    }
                    var tr = document.createElement('tr');
                    var statusText = territory.status ? 'Completo' : 'Incompleto';
                    tr.innerHTML = '<td>' + territory.id + '</td><td>' + territory.number + '</td><td>' + territory.zone + '</td><td>' + statusText + '</td><td><button class="view-lots-btn" data-id="' + territory.id + '">Ver Lotes</button></td>';
                    tbody.appendChild(tr);
                    var territoryLayer = L.geoJSON(territory.geojson, {
                        style: { color: color, fillColor: color, fillOpacity: 0.3, weight: 2 }
                    }).addTo(mainMap);
                    mainLayers[territory.id] = territoryLayer;
                });
                document.querySelectorAll('.view-lots-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        var territoryId = this.getAttribute('data-id');
                        openLotsModal(territoryId);
                    });
                });
            });

        var lotsMap;
        var lotsLayerGroup;

        function openLotsModal(territoryId) {
            fetch('/territories/' + territoryId)
                .then(response => response.json())
                .then(territory => {
                    document.getElementById('lotsModal').style.display = 'block';
                    document.getElementById('modalTitle').innerText = 'Território ' + territory.number + ' - ' + territory.zone;
                    if (!lotsMap) {
                        lotsMap = L.map('lotsMap');
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            maxZoom: 18,
                            attribution: '&copy; OpenStreetMap contributors'
                        }).addTo(lotsMap);
                    }
                    if (lotsLayerGroup) {
                        lotsMap.removeLayer(lotsLayerGroup);
                    }
                    if (territory.geojson && territory.geojson.features) {
                        territory.geojson.features.forEach((feat, index) => {
                            if (!feat.properties) {
                                feat.properties = {};
                            }
                            feat.properties.index = index;
                        });
                    }
                    lotsLayerGroup = L.geoJSON(territory.geojson, {
                        style: function(feature) {
                            var done = feature.properties && feature.properties.done === true;
                            return {
                                color: done ? 'green' : 'red',
                                fillColor: done ? 'green' : 'red',
                                fillOpacity: 0.5,
                                weight: 2
                            };
                        },
                        onEachFeature: function(feature, layer) {
                            layer.on('click', function() {
                                var currentDone = feature.properties && feature.properties.done === true;
                                var newDone = !currentDone;
                                var newColor = newDone ? 'green' : 'red';
                                layer.setStyle({ color: newColor, fillColor: newColor });
                                fetch('/territories/' + territoryId + '/lots/' + feature.properties.index, {
                                    method: 'PUT',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({ done: newDone })
                                })
                                    .then(res => res.json())
                                    .then(result => {
                                        feature.properties.done = newDone;
                                        if (result.status !== territory.status) {
                                            territory.status = result.status;
                                            var rows = document.querySelectorAll('#territoriesTable tbody tr');
                                            rows.forEach(row => {
                                                var idCell = row.cells[0];
                                                var statusCell = row.cells[3];
                                                if (idCell && idCell.innerText == territoryId) {
                                                    statusCell.innerText = territory.status ? 'Completo' : 'Incompleto';
                                                }
                                            });
                                            var color = 'red';
                                            if (territory.status) {
                                                if (result.updated_at) {
                                                    var updatedDate = new Date(result.updated_at);
                                                    var sixMonthsAgo = new Date();
                                                    sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
                                                    if (updatedDate > sixMonthsAgo) {
                                                        color = 'green';
                                                    }
                                                } else {
                                                    color = 'red';
                                                }
                                            }
                                            if (mainLayers[territoryId]) {
                                                mainLayers[territoryId].setStyle({ color: color, fillColor: color });
                                            }
                                        }
                                        territory.updated_at = result.updated_at;
                                    })
                                    .catch(err => {
                                        console.error(err);
                                    });
                            });
                        }
                    }).addTo(lotsMap);
                    lotsMap.fitBounds(lotsLayerGroup.getBounds());
                    lotsMap.invalidateSize();
                });
        }

        document.getElementById('closeModal').addEventListener('click', function() {
            document.getElementById('lotsModal').style.display = 'none';
        });
    </script>
</body>
</html>
